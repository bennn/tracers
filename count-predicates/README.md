count-predicates
===

Scripts to count the number of times _predicate_ contracts on a typed/untyped boundary are executed at runtime.
The goal is to identify high-traffic boundaries for a fixed set of program inputs.

We track the contracts generated by the `require/typed` form as an approximation to getting an exact flow of run-time values.

Here is example output from running this repo's `examples/list/main.rkt`:
```
Results
=======
Created 4 contracts
Checked contracts 15 times
The worst boundary (from.rkt -> main.rkt) created 4 contracts and caused 15 checks
Worst values, for each boundary:
- [from.rkt => main.rkt] value 'lam' checked 7 times
```

Projects with more modules will generate more results.
Here are post-processed results for the larger program `examples/snake`:
```
Results for 'snake.rktd'
====================
  29 contracts generated
  17575714 total checks
* Boundary from 'data.rkt' to 'data-adaptor.rkt' created 9 contracts (31%) and caused 15826005 checks (90%)
```

There are 15 boundaries in this program, but the one between `data.rkt` and `data-adaptor.rkt` is by far the worst.
That's why it's the only one shown after post-processing.


Overview
---

This program works by:
1. Modifying a git-installed copy of Racket to log data to `stdout` at runtime
2. Reading the output generated when new programs are run


Pre-Requisites
---
- Racket v6.3.0.1 or later, installed through [git](http://github.com/racket/racket)

The git install is crucial.
Having `6.3.0.1` is less important, but we haven't made certain these scripts work for all versions.

(If you want to go ahead anyway, look at the files in the `patch/` folder and make similar changes to your install.)


Install & Uninstall
---

Running `make setup` will recompile parts of your local Racket install.
Running `make clean` will undo these changes.

Beware, `clean` assumes that you have a `_backup` folder on-hand.
Running `setup` creates one of these folders, so don't delete it!

If you want to specify which Racket to modify, run `racket setup.rkt RKT-DIR` with your favorite `RKT-DIR`.

After installing, you should see new messages to stdout whenever you run any Racket program (that uses `require/typed`).


Running
---

Before running a new program, make sure all its boundaries are annotated with `require/typed`.

The `scripts/` directory has tools to run.
- `scripts/trace-run.rkt` is for running a program.
  Given `FILE.rkt`, run `racket scripts/trace-run.rkt -o FILE.data FILE.rkt` to generate summary results on the console and detailed results in the new `FILE.data`
- `scripts/list-boundaries.rkt` is for analyzing detailed output.
  Given a data file generated by `trace-run`, it prints detailed results; for example, `racket scripts/list-boundaries FILE.data`.



That's all. Enjoy.
